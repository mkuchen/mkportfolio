/*
 * jQuery Address Plugin v1.5
 * http://www.asual.com/jquery/address/
 *
 * Copyright (c) 2009-2010 Rostislav Hristov
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * Date: 2012-11-18 23:51:44 +0200 (Sun, 18 Nov 2012)
 */
(function(e){e.address=function(){var t=function(t){return t=e.extend(e.Event(t),function(){for(var t={},n=e.address.parameterNames(),r=0,i=n.length;r<i;r++)t[n[r]]=e.address.parameter(n[r]);return{value:e.address.value(),path:e.address.path(),pathNames:e.address.pathNames(),parameterNames:n,parameters:t,queryString:e.address.queryString()}}.call(e.address)),e(e.address).trigger(t),t},n=function(e){return Array.prototype.slice.call(e)},r=function(){return e().bind.apply(e(e.address),Array.prototype.slice.call(arguments)),e.address},i=function(){return e().unbind.apply(e(e.address),Array.prototype.slice.call(arguments)),e.address},s=function(){return I.pushState&&_.state!==x},o=function(){return("/"+q.pathname.replace(new RegExp(_.state),"")+q.search+(u()?"#"+u():"")).replace(z,"/")},u=function(){var e=q.href.indexOf("#");return e!=-1?h(q.href.substr(e+1),M):""},a=function(){return s()?o():u()},f=function(){return"javascript"},l=function(e){return e=e.toString(),(_.strict&&e.substr(0,1)!="/"?"/":"")+e},h=function(e,t){return _.crawlable&&t?(e!==""?"!":"")+e:e.replace(/^\!/,"")},p=function(e,t){return parseInt(e.css(t),10)},d=function(){if(!K){var e=a();decodeURI(Z)!=decodeURI(e)&&(H&&P<7?q.reload():(H&&!W&&_.history&&U(y,50),_old=Z,Z=e,v(M)))}},v=function(e){var n=t(k);e=t(e?L:A),U(g,10),(n.isDefaultPrevented()||e.isDefaultPrevented())&&m()},m=function(){Z=_old,s()?I.popState({},"",_.state.replace(/\/$/,"")+(Z===""?"/":Z)):(K=O,B?_.history?q.hash="#"+h(Z,O):q.replace("#"+h(Z,O)):Z!=a()&&(_.history?q.hash="#"+h(Z,O):q.replace("#"+h(Z,O))),H&&!W&&_.history&&U(y,50),B?U(function(){K=M},1):K=M)},g=function(){if(_.tracker!=="null"&&_.tracker!==T){var t=e.isFunction(_.tracker)?_.tracker:j[_.tracker],n=(q.pathname+q.search+(e.address&&!s()?e.address.value():"")).replace(/\/\//,"/").replace(/^\/$/,"");e.isFunction(t)?t(n):e.isFunction(j.urchinTracker)?j.urchinTracker(n):j.pageTracker!==x&&e.isFunction(j.pageTracker._trackPageview)?j.pageTracker._trackPageview(n):j._gaq!==x&&e.isFunction(j._gaq.push)&&j._gaq.push(["_trackPageview",decodeURI(n)])}},y=function(){var e=f()+":"+M+";document.open();document.writeln('<html><head><title>"+F.title.replace(/\'/g,"\\'")+"</title><script>var "+N+' = "'+encodeURIComponent(a()).replace(/\'/g,"\\'")+(F.domain!=q.hostname?'";document.domain="'+F.domain:"")+"\";</script></head></html>');document.close();";P<7?X.src=e:X.contentWindow.location.replace(e)},b=function(){if(V&&$!=-1){var e,t,n=V.substr($+1).split("&");for(e=0;e<n.length;e++)t=n[e].split("="),/^(autoUpdate|crawlable|history|strict|wrap)$/.test(t[0])&&(_[t[0]]=isNaN(t[1])?/^(true|yes)$/i.test(t[1]):parseInt(t[1],10)!==0),/^(state|tracker)$/.test(t[0])&&(_[t[0]]=t[1]);V=T}_old=Z,Z=a()},w=function(){if(!Q){Q=O,b();var n=function(){E.call(this),S.call(this)},r=e("body").ajaxComplete(n);n(),_.wrap&&(e("body > *").wrapAll('<div style="padding:'+(p(r,"marginTop")+p(r,"paddingTop"))+"px "+(p(r,"marginRight")+p(r,"paddingRight"))+"px "+(p(r,"marginBottom")+p(r,"paddingBottom"))+"px "+(p(r,"marginLeft")+p(r,"paddingLeft"))+'px;" />').parent().wrap('<div id="'+N+'" style="height:100%;overflow:auto;position:relative;'+(B&&!window.statusbar.visible?"resize:both;":"")+'" />'),e("html, body").css({height:"100%",margin:0,padding:0,overflow:"hidden"}),B&&e('<style type="text/css" />').appendTo("head").text("#"+N+"::-webkit-resizer { background-color: #fff; }")),H&&!W&&(n=F.getElementsByTagName("frameset")[0],X=F.createElement((n?"":"i")+"frame"),X.src=f()+":"+M,n?(n.insertAdjacentElement("beforeEnd",X),n[n.cols?"cols":"rows"]+=",0",X.noResize=O,X.frameBorder=X.frameSpacing=0):(X.style.display="none",X.style.width=X.style.height=0,X.tabIndex=-1,F.body.insertAdjacentElement("afterBegin",X)),U(function(){e(X).bind("load",function(){var e=X.contentWindow;_old=Z,Z=e[N]!==x?e[N]:"",Z!=a()&&(v(M),q.hash=h(Z,O))}),X.contentWindow[N]===x&&y()},50)),U(function(){t("init"),v(M)},1),s()||(H&&P>7||!H&&W?j.addEventListener?j.addEventListener(C,d,M):j.attachEvent&&j.attachEvent("on"+C,d):R(d,50)),"state"in window.history&&e(window).trigger("popstate")}},E=function(){var t,n=e("a"),r=n.size(),i=-1,s=function(){++i!=r&&(t=e(n.get(i)),t.is('[rel*="address:"]')&&t.address('[rel*="address:"]'),U(s,1))};U(s,1)},S=function(){if(_.crawlable){var t=q.pathname.replace(/\/$/,"");e("body").html().indexOf("_escaped_fragment_")!=-1&&e('a[href]:not([href^=http]), a[href*="'+document.domain+'"]').each(function(){var n=e(this).attr("href").replace(/^http:/,"").replace(new RegExp(t+"/?$"),"");(n===""||n.indexOf("_escaped_fragment_")!=-1)&&e(this).attr("href","#"+encodeURI(decodeURIComponent(n.replace(/\/(.*)\?_escaped_fragment_=(.*)$/,"!$2"))))})}},x,T=null,N="jQueryAddress",C="hashchange",k="change",L="internalChange",A="externalChange",O=!0,M=!1,_={autoUpdate:O,crawlable:M,history:O,strict:O,wrap:M},D=e.browser,P=parseFloat(D.version),H=!e.support.opacity,B=D.webkit||D.safari,j=function(){try{return top.document!==x&&top.document.title!==x?top:window}catch(e){return window}}(),F=j.document,I=j.history,q=j.location,R=setInterval,U=setTimeout,z=/\/{2,9}/g;D=navigator.userAgent;var W="on"+C in j,X,V=e("script:last").attr("src"),$=V?V.indexOf("?"):-1,J=F.title,K=M,Q=M,G=O,Y=M,Z=a();_old=Z;if(H){P=parseFloat(D.substr(D.indexOf("MSIE")+4)),F.documentMode&&F.documentMode!=P&&(P=F.documentMode!=8?7:8);var et=F.onpropertychange;F.onpropertychange=function(){et&&et.call(F),F.title!=J&&F.title.indexOf("#"+a())!=-1&&(F.title=J)}}I.navigationMode&&(I.navigationMode="compatible");if(document.readyState=="complete")var tt=setInterval(function(){e.address&&(w(),clearInterval(tt))},50);else b(),e(w);return e(window).bind("popstate",function(){decodeURI(Z)!=decodeURI(a())&&(_old=Z,Z=a(),v(M))}).bind("unload",function(){j.removeEventListener?j.removeEventListener(C,d,M):j.detachEvent&&j.detachEvent("on"+C,d)}),{bind:function(){return r.apply(this,n(arguments))},unbind:function(){return i.apply(this,n(arguments))},init:function(){return r.apply(this,["init"].concat(n(arguments)))},change:function(){return r.apply(this,[k].concat(n(arguments)))},internalChange:function(){return r.apply(this,[L].concat(n(arguments)))},externalChange:function(){return r.apply(this,[A].concat(n(arguments)))},baseURL:function(){var e=q.href;return e.indexOf("#")!=-1&&(e=e.substr(0,e.indexOf("#"))),/\/$/.test(e)&&(e=e.substr(0,e.length-1)),e},autoUpdate:function(e){return e!==x?(_.autoUpdate=e,this):_.autoUpdate},crawlable:function(e){return e!==x?(_.crawlable=e,this):_.crawlable},history:function(e){return e!==x?(_.history=e,this):_.history},state:function(e){if(e!==x){_.state=e;var t=o();return _.state!==x&&(I.pushState?t.substr(0,3)=="/#/"&&q.replace(_.state.replace(/^\/$/,"")+t.substr(2)):t!="/"&&t.replace(/^\/#/,"")!=u()&&U(function(){q.replace(_.state.replace(/^\/$/,"")+"/#"+t)},1)),this}return _.state},strict:function(e){return e!==x?(_.strict=e,this):_.strict},tracker:function(e){return e!==x?(_.tracker=e,this):_.tracker},wrap:function(e){return e!==x?(_.wrap=e,this):_.wrap},update:function(){return Y=O,this.value(Z),Y=M,this},title:function(e){return e!==x?(U(function(){J=F.title=e,G&&X&&X.contentWindow&&X.contentWindow.document&&(X.contentWindow.document.title=e,G=M)},50),this):F.title},value:function(e){if(e!==x){e=l(e),e=="/"&&(e="");if(Z==e&&!Y)return;_old=Z,Z=e;if(_.autoUpdate||Y)v(O),s()?I[_.history?"pushState":"replaceState"]({},"",_.state.replace(/\/$/,"")+(Z===""?"/":Z)):(K=O,B?_.history?q.hash="#"+h(Z,O):q.replace("#"+h(Z,O)):Z!=a()&&(_.history?q.hash="#"+h(Z,O):q.replace("#"+h(Z,O))),H&&!W&&_.history&&U(y,50),B?U(function(){K=M},1):K=M);return this}return l(Z)},path:function(e){if(e!==x){var t=this.queryString(),n=this.hash();return this.value(e+(t?"?"+t:"")+(n?"#"+n:"")),this}return l(Z).split("#")[0].split("?")[0]},pathNames:function(){var e=this.path(),t=e.replace(z,"/").split("/");return(e.substr(0,1)=="/"||e.length===0)&&t.splice(0,1),e.substr(e.length-1,1)=="/"&&t.splice(t.length-1,1),t},queryString:function(e){if(e!==x){var t=this.hash();return this.value(this.path()+(e?"?"+e:"")+(t?"#"+t:"")),this}return e=Z.split("?"),e.slice(1,e.length).join("?").split("#")[0]},parameter:function(t,n,r){var i,s;if(n!==x){var o=this.parameterNames();s=[],n=n===x||n===T?"":n.toString();for(i=0;i<o.length;i++){var u=o[i],a=this.parameter(u);typeof a=="string"&&(a=[a]),u==t&&(a=n===T||n===""?[]:r?a.concat([n]):[n]);for(var f=0;f<a.length;f++)s.push(u+"="+a[f])}return e.inArray(t,o)==-1&&n!==T&&n!==""&&s.push(t+"="+n),this.queryString(s.join("&")),this}if(n=this.queryString()){r=[],s=n.split("&");for(i=0;i<s.length;i++)n=s[i].split("="),n[0]==t&&r.push(n.slice(1).join("="));if(r.length!==0)return r.length!=1?r:r[0]}},parameterNames:function(){var t=this.queryString(),n=[];if(t&&t.indexOf("=")!=-1){t=t.split("&");for(var r=0;r<t.length;r++){var i=t[r].split("=")[0];e.inArray(i,n)==-1&&n.push(i)}}return n},hash:function(e){return e!==x?(this.value(Z.split("#")[0]+(e?"#"+e:"")),this):(e=Z.split("#"),e.slice(1,e.length).join("#"))}}}(),e.fn.address=function(t){var n;return typeof t=="string"&&(n=t,t=undefined),e(this).attr("address")||e(n?n:this).live("click",function(n){if(n.shiftKey||n.ctrlKey||n.metaKey||n.which==2)return!0;e(this).is("a")&&(n.preventDefault(),n=t?t.call(this):/address:/.test(e(this).attr("rel"))?e(this).attr("rel").split("address:")[1].split(" ")[0]:e.address.state()!==undefined&&!/^\/?$/.test(e.address.state())?e(this).attr("href").replace(new RegExp("^(.*"+e.address.state()+"|\\.)"),""):e(this).attr("href").replace(/^(#\!?|\.)/,""),e.address.value(n))}).live("submit",function(n){e(this).is("form")&&(n.preventDefault(),n=e(this).attr("action"),n=t?t.call(this):(n.indexOf("?")!=-1?n.replace(/&$/,""):n+"?")+e(this).serialize(),e.address.value(n))}).attr("address",!0),this}})(jQuery);